{% extends 'main/base.html' %}
{% load static %}

{% block references %}
<link type="text/css" href="{% static 'css/posts.css' %}" rel="stylesheet" />
<link type="text/css" href="{% static 'css/groups.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div id="main" class="container">
	{% if messages %}
	<div class="row">
		{% for message in messages %}
		<div class="col-12"><div class="box message {% if message.tags %} {{ message.tags }}"{% endif %}>{{ message }}</div></div>
		{% endfor %}
	</div>
	{% endif %}

	<div class="row" style="height: 100%">
		<div id="posts" class="col-12 {% if user.is_authenticated and not user.is_anonymous %} col-md-8 {% endif %}">
			<div class="box">
				<div class="groupTitle">
						<img src="{{ group.photo.url }}">
						{{ group.name }}
				</div>
			</div>

			{% if user.is_authenticated and not user.is_anonymous and is_member %}
			<div id="compose" class="box">
				<form method="post" action="{% url 'submit-post-to-group' group.pk %}">
				 {% csrf_token %}
				 <input type="hidden" id="group_id" name="group_id" value="{{ group.pk }}" />
					<div class="input-group">
						<textarea maxlength="5000" name='body' class="form-control custom-control autoExpand" id="compose-box" rows="2" placeholder="Submit post to {{ group.name }}" style="resize:none"></textarea>
						<button class="input-group-addon btn btn-primary" type="submit" style="border-radius: 0px">post</button>
					</div>
				</form>
			</div>
			{% endif %}
			{% for post in posts %}
			<div class="box">
				<div class="box-header">
					Someone posted...
					<div class="float-right" style="font-size:1.3em;">
					{{ post.likes }}	<i class="fas fa-arrow-circle-up fa-lg like-button" onclick="like()" style="margin-left:5px"></i>
					</div>
				</div>
				<hr>
				{{ post.body }}
			</div>
			{% endfor %}
		</div>
		{% if user.is_authenticated and not user.is_anonymous %}
		<div class="d-none d-sm-block col-md-4" style="padding:0px">
			<div id="sidebar">
				<div class="box">
					<h1> Group Actions </h1>

					<hr>
					<div class="suggested-item">
						<div class="groupLinks d-flex flex-column justify-content-center">
							{% if is_member %}
								{% if is_admin and group.moderated %}
										<a href="{% url 'approve-posts' group.pk %}">
										Approve posts
									</a>
								{% endif %}
								{% if is_owner %}
									{% if group.moderated %}
									<a href="#add_admin_modal" data-toggle="modal">
										Modify admins
									</a>
									{% endif %}
									<a href="#change_owner_modal" data-toggle="modal">
										Change owner
									</a>
								{% endif %}
								<a href="">
									Invite members
								</a>
								<a href="{% url 'leave-group' group.pk %}">
									Leave group
								</a>
								{% if is_owner %}
									<a id="delete-group" href=''>
										Delete group
									</a>
								{% endif %}
							{% else %}
								<a href="{% url 'join-group' group.pk %}">
									Join group
								</a>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endif %}
	</div>
</div>
{% if is_owner %}
<!-- Change Owner Modal-->
<div class="modal fade" id="change_owner_modal" tabindex="-1" role="dialog" aria-labelledby="changeOwnerModal" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 >Change Owner</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="change-owner-search-form" role="form" method="post">
					<input type="hidden" name="group-id" value="{{ group.pk }}" />
					<div class="form-group">
						<input type="search" class="form-control" id="change-owner-search" name="search" placeholder="Filter members" ic-post-to="{% url 'change-group-owner-search' %}" ic-poll="1s" ic-on-beforeSend="xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');" ic-poll-repeats="1" ic-trigger-on="keyup changed" ic-trigger-delay="200ms" ic-target="#change-owner-search-result-container" />
					</div>
				</form>
				<table class="table table-striped" style="width:100%">
					<span id="change-owner-search-result-container"></span>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
<!-- Add admin Modal-->
<div class="modal fade" id="add_admin_modal" tabindex="-1" role="dialog" aria-labelledby="addAdminModal" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 >Add Admin</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="add-admin-search-form" role="form" method="post">
					<input type="hidden" name="group-id" value="{{ group.pk }}" />
					<div class="form-group">
						<input type="search" class="form-control" id="add-admin-search" name="search" placeholder="Filter members" ic-post-to="{% url 'add-admin-search' %}" ic-on-beforeSend="xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');" ic-poll="1s" ic-poll-repeats="1" ic-trigger-on="keyup changed" ic-trigger-delay="200ms" ic-target="#search-result-container" />
					</div>
				</form>
				<table class="table table-striped" style="width:100%">
					<span id="search-result-container"></span>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

{% endif %}


<!-- Settings Modal -->
<div class="modal fade" id="settings_overlay" tabindex="-1" role="dialog" aria-labelledby="settingsModal" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 >Settings</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form>
					<div class="form-group">
						<label for="exampleInputEmail1">Email address</label>
						<input type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Enter email">
						<small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
					</div>
					<div class="form-group">
						<label for="exampleInputPassword1">Password</label>
						<input type="password" class="form-control" id="exampleInputPassword1" placeholder="Password">
					</div>
					<div class="form-check">
						<input type="checkbox" class="form-check-input" id="exampleCheck1">
						<label class="form-check-label" for="exampleCheck1">Check me out</label>
					</div>
					<button type="submit" class="btn btn-primary">Submit</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary" onclick="saveSettings()" data-dismiss="modal">Save changes</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block javascript %}

{% if is_owner %}
<script src="{% static 'js/csrftoken.js' %}"></script>
<script>
function changeOwner(pk) {
	var r = confirm('Are you sure you want to change the owner of the group to this person? This action cannot be undone.');
	if (r==true) {
		function csrfSafeMethod(method) {
			// these HTTP methods do not require CSRF protection
			return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}
		// send ajax
		$.ajax({
			beforeSend: function(xhr, settings) {
					if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
						xhr.setRequestHeader("X-CSRFToken", csrftoken);
					}
				},
			url: '{% url "change-group-owner" group.pk %}', // url where to submit the request
			type : "POST", // type of action POST || GET
			dataType : 'json', // data type
			data : { 'user-id': pk, 'group': {{ group.pk }} },
			success : function(result) {
				console.log(result);
				if (result['success']) {
					window.location.href = '{% url "groups" %}';
				}
			},
		});
	};
	
};

$('#delete-group').click( function(e) {
	e.preventDefault();
	var r = confirm('Are you sure you want to delete the group {{ group.name }}?\nThis action cannot be reversed, and all posts in the group will be lost forever.');
	if (r==true) {
		var r = confirm('If you click "OK" then {{ group.name }} and all of its posts will forever be gone. Are you sure you want to do this?');
		if (r==true) {
			function csrfSafeMethod(method) {
				// these HTTP methods do not require CSRF protection
				return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}
            // send ajax
            $.ajax({
				beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
							xhr.setRequestHeader("X-CSRFToken", csrftoken);
						}
					},
                url: '{% url "delete-group" group.pk %}', // url where to submit the request
                type : "POST", // type of action POST || GET
                dataType : 'json', // data type
                data : { 'group': {{ group.pk }} },
                success : function(result) {
					console.log(result);
					if (result['success']) {
						window.location.href = '{% url "groups" %}';
					}
				},
			});
		};
	};
	return false;
});
</script>
{% endif %}
{% endblock %}
